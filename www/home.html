<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
  <title>Home</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="css/index.css" rel="stylesheet" type="text/css" />

  <!-- Core libs -->
  <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
  <script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
  <script type="text/javascript" src="js/jquery-1.8.9.ui.js"></script>

  <!-- Crypto libs -->
  <script type="text/javascript" src="js/System.debug.js"></script>
  <script type="text/javascript" src="js/System.IO.debug.js"></script>
  <script type="text/javascript" src="js/System.Text.debug.js"></script>
  <script type="text/javascript" src="js/System.Convert.debug.js"></script>
  <script type="text/javascript" src="js/System.BitConverter.debug.js"></script>
  <script type="text/javascript" src="js/System.BigInt.debug.js"></script>
  <script type="text/javascript" src="js/System.Security.Cryptography.SHA1.debug.js"></script>
  <script type="text/javascript" src="js/System.Security.Cryptography.debug.js"></script>
  <script type="text/javascript" src="js/System.Security.Cryptography.RSA.debug.js"></script>

  <!-- Spinner -->
  <script src="js/spin.min.js"></script>

  <!-- Minimal modal/layout safeguards -->
  <style type="text/css">
    #messagePopup {
      display: none;
    }

    .ui-dialog {
      border-radius: 10px;
      overflow: hidden;
    }

    .ui-dialog .ui-dialog-content {
      padding: 16px !important;
    }

    .ui-dialog-buttonpane {
      padding: 8px 16px !important;
    }

    .ui-widget-overlay {
      background: rgba(0, 0, 0, 0.35) !important;
    }
  </style>

  <!-- Drop-down helper (fixed type) -->
  <script type="text/javascript">
    function myFunction() { document.getElementById("myDropdown").classList.toggle("show"); }
    window.onclick = function (e) {
      if (!e.target.matches('.dropbtn')) {
        var d = document.getElementsByClassName("dropdown-content");
        for (var i = 0; i < d.length; i++) { if (d[i].classList.contains('show')) d[i].classList.remove('show'); }
      }
    }
  </script>
</head>

<body>
  <div class="container">
    <div class="container categoryContainer">
      <table class="header" style="width:100%; table-layout:fixed;">
        <tr>
          <td class="header" style="width:33%;">
            <select class="category" id="category">
              <option value="4">all deals</option>
              <option value="1">food</option>
              <option value="2">services</option>
              <option value="3">activities</option>
              <option value="5">retail</option>
              <option value="6">Exclude Premium Deals</option>
            </select>
          </td>
          <td class="header" style="text-align:center; width:34%;">
            <img src="images/black-glass.png" style="width:25%;" alt="Glass Card">
          </td>
          <td class="header" style="width:33%;">
            <select class="category" id="radius">
              <option value="1" selected="selected">60 mi</option>
              <option value="2">30 mi</option>
              <option value="3">15 mi</option>
              <option value="4">5 mi</option>
            </select>
          </td>
        </tr>
      </table>
    </div>

    <center>
      <div class="merchants" id="merchants" style="margin-top:1%; margin-bottom:20px;"></div>
    </center>
  </div>

  <footer class="menu" role="navigation">
    <a class="tab is-active" href="home.html" aria-label="Discover">
      <img src="images/search-gradient.png" alt="">
      <span>Discover</span>
    </a>
    <a class="tab" href="profile.html" aria-label="Account">
      <img src="images/account-grey.png" alt="">
      <span>Account</span>
    </a>
  </footer>


  <!-- Modal -->
  <div id="messagePopup" title="">
    <label id="messageText"></label>
  </div>

  <script type="text/javascript">
      (function () {
        /* ===========================
           Tunables
        =========================== */
        var GEO_STORED_FRESH_MS = 30 * 60 * 1000;   // Treat stored coords as fresh up to 30 min
        var FIRST_FIX_GATE_MS = 6000;             // First-run grace window to avoid premature prompt
        var AJAX_TIMEOUT_MS = 15000;            // Network guard
        var MERCHANTS_CACHE_TTL = 5 * 60 * 1000;    // Merchant HTML cache TTL (5 min)
        var COORDS_ROUND_PLACES = 2;                // Round lat/lon for cache key (~1.1km)
        var SPINNER_DELAY_MS = 800;              // Delay before showing spinner (prevents flash)
        var FAST_GETPOSITION_TIMEOUT = 3000;             // Quick one-shot GPS timeout
        var FAST_GETPOSITION_MAXAGE = 5 * 60 * 1000;    // Accept OS cached fix up to 5 min
        var FALLBACK_LAT = 43.8260574;       // Fallback coords (customize)
        var FALLBACK_LON = -111.7837469;

        /* ===========================
           State
        =========================== */
        var spinner, spinnerTarget;
        var spinnerDelayTimer = null;
        var spinnerVisible = false;

        var latitude = "", longitude = "";
        var watchId = null;
        var gotAnyFixThisSession = false;
        var firstFixTimerFired = false;

        /* ===========================
           Utilities / logging
        =========================== */
        function log() { try { console.log.apply(console, ["[home]"].concat([].slice.call(arguments))); } catch (e) { } }

        function displayMessage(title, message, buttonsSpec) {
          $('#messageText').html(message);
          $('#messagePopup').dialog({
            modal: true,
            width: Math.min(window.innerWidth - 40, 420),
            closeOnEscape: false,
            resizable: false,
            draggable: false,
            open: function () { $(this).siblings('.ui-dialog-titlebar').remove(); },
            buttons: buttonsSpec || [{ text: "Close", click: function () { $(this).dialog('close'); } }]
          });
        }

        function showSpinnerDelayed() {
          // Only schedule a spinner if it's not already visible or scheduled
          if (spinnerVisible || spinnerDelayTimer) return;
          spinnerDelayTimer = setTimeout(function () {
            spinnerDelayTimer = null;
            spinnerVisible = true;
            var opts = {
              lines: 12, length: 24, width: 3, radius: 10, scale: 1, corners: 1, color: '#1fab89',
              opacity: 0.2, direction: 1, speed: 1, trail: 60, fps: 20, zIndex: 2e9,
              className: 'spinner', top: '50%', left: '50%', position: 'absolute'
            };
            spinnerTarget = document.getElementById('merchants');
            spinner = new Spinner(opts).spin(spinnerTarget);
          }, SPINNER_DELAY_MS);
        }

        function hideSpinner() {
          if (spinnerDelayTimer) { clearTimeout(spinnerDelayTimer); spinnerDelayTimer = null; }
          if (spinnerVisible) {
            try { spinner && spinner.stop(); } catch (e) { }
            spinnerVisible = false;
          }
        }

        function encrypt(textToEncrypt) {
          var unencryptedBytes = System.Text.Encoding.UTF8.GetBytes(textToEncrypt);
          var rsa = new System.Security.Cryptography.RSACryptoServiceProvider(256);
          rsa.FromXmlString("<RSAKeyValue><Modulus>j47ELmY9UH+ugOpzj2qiuL0uWtTIUD1Ts2VK0Y5rf3s65T/iDWnCoSL+BstDgR61YpAsRfCGSjrnbr+AEkmkALkFlkmWcr7s3dUv2SSnOh0FDHE3r/DGpSbi99sscrH2PnmDRyrg7060ITmPV4h/h39sbQVVJjPFD0hIJK3ScbUPyg0Jfx83l0YfKOLd0q/KAwNspV4Lem2kiT50EUATuzQZerid937phL69kUXlaZn6z/SG1Zr2QpHsH7K7kAejpB2lFOEgrXLv29aRHE7f9yR8oNk0l7/iX5CiHEJ+XdD/mRVVJ8oEdjJ5xJZFJQrPMCc2BF7HwrqWxOhFYLFpfw==</Modulus><Exponent>AQAB</Exponent></RSAKeyValue>");
          var encryptedBytes = rsa.Encrypt(unencryptedBytes, false);
          return System.Convert.ToBase64String(encryptedBytes);
        }

        function coordsAreFresh(ts) {
          if (!ts) return false;
          var age = Date.now() - parseInt(ts, 10);
          return age >= 0 && age <= GEO_STORED_FRESH_MS;
        }

        function saveCoords(lat, lon) {
          latitude = lat; longitude = lon;
          localStorage.setItem("latitude", lat);
          localStorage.setItem("longitude", lon);
          localStorage.setItem("locationTimestamp", String(Date.now()));
        }

        /* ===========================
           Merchants cache (instant render)
        =========================== */
        function rnd(x, places) { var m = Math.pow(10, places); return Math.round(parseFloat(x) * m) / m; }
        function mkKey(lat, lon, cat, rad) { return ['merchants', rnd(lat, COORDS_ROUND_PLACES), rnd(lon, COORDS_ROUND_PLACES), cat, rad].join('|'); }

        function readMerchantsCache(key) {
          try {
            var raw = localStorage.getItem('merchantsCache:' + key);
            if (!raw) return null;
            var obj = JSON.parse(raw);
            if (!obj || !obj.html || !obj.ts) return null;
            if ((Date.now() - obj.ts) > MERCHANTS_CACHE_TTL) return null;
            return obj.html;
          } catch (e) { return null; }
        }

        function writeMerchantsCache(key, html) {
          try {
            localStorage.setItem('merchantsCache:' + key, JSON.stringify({ ts: Date.now(), html: html }));
          } catch (e) { }
        }

        /* ===========================
           Data calls
        =========================== */
        function ajaxSavings() {
          try {
            var deviceID = localStorage.getItem("deviceID") || ("dev-" + Date.now());
            localStorage.setItem("deviceID", deviceID);
            var token = encrypt(JSON.stringify({ DeviceID: deviceID }));
            $.ajax({
              url: "https://glasscard.org/dataaccessprod4/getSavings.ashx",
              type: "POST",
              data: "Token=" + encodeURIComponent(token),
              dataType: "text",
              crossDomain: true,
              timeout: AJAX_TIMEOUT_MS
            });
          } catch (e) { /* non-blocking */ }
        }

        function ajaxMerchants(options) {
          options = options || {};
          var categoryText = $('#category option:selected').text();
          var radiusText = $('#radius option:selected').text().substring(0, 2);
          var key = mkKey(latitude, longitude, categoryText, radiusText);

          if (options.showInstantCache) {
            var cached = readMerchantsCache(key);
            if (cached) {
              log('rendering merchants from cache key:', key);
              $('#merchants').html(cached);
            }
          }

          if (!options.background) showSpinnerDelayed();

          $.ajax({
            url: "https://glasscard.org/dataaccessprod4/getMerchants.ashx",
            type: "POST",
            data: "AccountId=" + encodeURIComponent(localStorage.getItem("accountId") || "") +
              "&Latitude=" + encodeURIComponent(latitude) +
              "&Longitude=" + encodeURIComponent(longitude) +
              "&Category=" + encodeURIComponent(categoryText) +
              "&Radius=" + encodeURIComponent(radiusText),
            dataType: "text",
            crossDomain: true,
            timeout: AJAX_TIMEOUT_MS,
            success: function (html) {
              $('#merchants').empty().append(html);
              writeMerchantsCache(key, html);
              hideSpinner();
            },
            error: function () {
              hideSpinner();
              if (!readMerchantsCache(key)) {
                displayMessage("",
                  "We couldn’t load nearby deals. Check your connection or try again.",
                  [
                    { text: "Retry", click: function () { $(this).dialog('close'); ajaxMerchants({ showInstantCache: true }); } },
                    { text: "Close", click: function () { $(this).dialog('close'); } }
                  ]
                );
              }
            }
          });
        }

        /* ===========================
           Location flow
        =========================== */
        function tryRenderWithStoredCoords(reason) {
          var lat = localStorage.getItem("latitude") || "";
          var lon = localStorage.getItem("longitude") || "";
          if (!lat || !lon) return false;
          latitude = lat; longitude = lon;
          log('using stored coords (' + reason + '):', lat, lon);
          ajaxMerchants({ showInstantCache: true }); // instant view + network refresh
          return true;
        }

        // Manual refresh (exposed)
        function refreshLocation(opts) {
          opts = opts || {};
          if (!(navigator && navigator.geolocation)) return;

          // Quick, one-shot position (returns OS cached instantly if recent)
          navigator.geolocation.getCurrentPosition(function (pos) {
            if (pos && pos.coords) {
              gotAnyFixThisSession = true;
              saveCoords(pos.coords.latitude, pos.coords.longitude);
              ajaxMerchants({ showInstantCache: true });
            }
          }, function (err) {
            log('manual getCurrentPosition error:', err);
            // Fall back to stored or fallback city if absolutely nothing
            if (!tryRenderWithStoredCoords('manual refresh fallback')) {
              saveCoords(FALLBACK_LAT, FALLBACK_LON);
              ajaxMerchants({ showInstantCache: true });
            }
          }, {
            timeout: FAST_GETPOSITION_TIMEOUT,
            maximumAge: FAST_GETPOSITION_MAXAGE,
            enableHighAccuracy: !!opts.highAccuracy
          });
        }

        function startWatchOnce() {
          if (!(navigator && navigator.geolocation)) { log('geolocation not available'); return; }
          if (watchId !== null) return;

          log('starting watchPosition');
          watchId = navigator.geolocation.watchPosition(function (pos) {
            if (pos && pos.coords) {
              gotAnyFixThisSession = true;
              saveCoords(pos.coords.latitude, pos.coords.longitude);
              // If merchants are empty (first display), render now
              if (!$('#merchants').children().length) {
                ajaxMerchants({ showInstantCache: true });
              }
            }
          }, function (err) {
            log('watchPosition error:', err && (err.code + ' ' + err.message));
          }, {
            maximumAge: FAST_GETPOSITION_MAXAGE, // allow OS cached fixes
            enableHighAccuracy: false
          });

          document.addEventListener('pause', function () {
            if (watchId !== null && navigator.geolocation.clearWatch) {
              log('clearing watch on pause');
              navigator.geolocation.clearWatch(watchId);
              watchId = null;
            }
          }, false);

          document.addEventListener('resume', function () {
            startWatchOnce();
            // On resume, instant cached render then quick refresh
            if (tryRenderWithStoredCoords('resume')) {
              ajaxMerchants({ showInstantCache: true });
              refreshLocation(); // quick refresh after resume
            }
          }, false);
        }

        function firstFixGate() {
          if (firstFixTimerFired) return;
          firstFixTimerFired = true;

          setTimeout(function () {
            if (gotAnyFixThisSession) { log('first fix arrived already'); return; }

            if (tryRenderWithStoredCoords('firstFixGate fallback')) {
              // Try to improve in background
              refreshLocation();
              return;
            }

            displayMessage("",
              "We need your phone's Location Services to show nearby deals. Please allow “While Using the App.”",
              [
                { text: "Retry", click: function () { $(this).dialog('close'); refreshLocation(); } },
                {
                  text: "Use Fallback Location", click: function () {
                    $(this).dialog('close');
                    saveCoords(FALLBACK_LAT, FALLBACK_LON);
                    ajaxMerchants({ showInstantCache: true });
                  }
                }
              ]
            );
          }, FIRST_FIX_GATE_MS);
        }

        function kickGeolocationFlow() {
          // 1) Instant render if we have anything stored
          var ts = localStorage.getItem('locationTimestamp') || "";
          if (coordsAreFresh(ts) && localStorage.getItem('latitude') && localStorage.getItem('longitude')) {
            latitude = localStorage.getItem('latitude');
            longitude = localStorage.getItem('longitude');
            log('fresh stored coords -> instant render');
            ajaxMerchants({ showInstantCache: true });
          } else if (tryRenderWithStoredCoords('kick flow')) {
            // stale but usable — show now; network refresh will happen below
          } else {
            // absolutely first-run: schedule spinner, but it won't show if we finish quickly
            showSpinnerDelayed();
          }

          // 2) Continuous updates (non-blocking)
          startWatchOnce();

          // 3) One quick refresh (non-blocking, accepts OS cache)
          refreshLocation();

          // 4) Safety gate to avoid permanent limbo on true first-run
          firstFixGate();
        }

        /* ===========================
           UI state
        =========================== */
        function initSelectionsFromStorage() {
          var c = localStorage.getItem("category"); if (c) $('#category').val(c).change();
          var r = localStorage.getItem("radius"); if (r) $('#radius').val((r * 1) + 1).change();
        }

        function setupChangeHandlers() {
          $('#category').off('change').on('change', function () {
            localStorage.setItem("category", $('#category option:selected').val());
            // Instant cache render; network refresh follows
            if (!tryRenderWithStoredCoords('category change')) showSpinnerDelayed();
            ajaxMerchants({ showInstantCache: true });
          });
          $('#radius').off('change').on('change', function () {
            localStorage.setItem("radius", $('#radius option:selected').index());
            if (!tryRenderWithStoredCoords('radius change')) showSpinnerDelayed();
            ajaxMerchants({ showInstantCache: true });
          });
        }

        /* ===========================
           Boot
        =========================== */
        function onDeviceReady() {
          ajaxSavings();
          initSelectionsFromStorage();
          setupChangeHandlers();
          kickGeolocationFlow();
        }

        $(document).ready(function () {
          // Try to render something immediately from cache if possible
          tryRenderWithStoredCoords('document ready');

          if (window.cordova) {
            document.addEventListener("deviceready", onDeviceReady, false);
          } else {
            onDeviceReady(); // web testing
          }

          // On back navigation, avoid spinner flash by delaying it
          window.addEventListener('pageshow', function () {
            if (tryRenderWithStoredCoords('pageshow')) {
              ajaxMerchants({ showInstantCache: true });
              refreshLocation();
            }
          });

          // Console helpers (manual refresh, etc.)
          window.__gc = {
            refreshLocation: refreshLocation, // e.g., window.__gc.refreshLocation({highAccuracy:true})
            reload: function () { ajaxMerchants({ showInstantCache: true }); },
            clearLocation: function () {
              localStorage.removeItem('latitude');
              localStorage.removeItem('longitude');
              localStorage.removeItem('locationTimestamp');
            }
          };
        });
      })();
  </script>

</body>

</html>